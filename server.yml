---
- name: Test Connection and Determine Remote User
  hosts: "{{ projects }},&web,&{{ env }}"
  gather_facts: false
  roles:
    - { role: connection, tags: [connection, always] }
    - { role: dynamic-hosts, tags: [dynamic-hosts, always] }

- name: Install prerequisites
  hosts: "!dynamic_hosts,{{ projects }},&web,&{{ env }}"
  gather_facts: false
  become: yes
  tasks:
    - name: Install Python 2.x
      raw: which python || sudo apt-get update && sudo apt-get install -qq -y python-simplejson
      register: python_check
      changed_when: not python_check.stdout | search('/usr/bin/python')

- name: WordPress Server - Install LEMP Stack with PHP 7.1 and MariaDB MySQL
  hosts: "!dynamic_hosts,{{ projects }},&web,&{{ env }}"
  become: yes
  roles:
    - { role: common, tags: [common] }
    - { role: swapfile, swapfile_size: 1GB, tags: [swapfile] }
    - { role: fail2ban, tags: [fail2ban] }
    - { role: ferm, tags: [ferm] }
    - { role: ntp, tags: [ntp] }
    - { role: users, tags: [users] }
    - { role: sshd, tags: [sshd] }
    - { role: mariadb, tags: [mariadb] }
    - { role: ssmtp, tags: [ssmtp, mail] }
    - { role: php, tags: [php] }
    - { role: memcached, tags: [memcached] }
    - { role: nginx, tags: [nginx] }
    - { role: logrotate, tags: [logrotate] }
    - { role: composer, tags: [composer] }
    - { role: wp-cli, tags: [wp-cli] }
    - { role: letsencrypt-general, tags: [letsencrypt, letsencrypt-general], when: sites_using_letsencrypt | count }
    - { role: wp-general, tags: [wp, wp-general, letsencrypt] }

- name: WordPress Server - Site-specific setup
  hosts: dynamic_hosts
  gather_facts: false
  become: yes
  roles:
    - { role: letsencrypt-sites, tags: [letsencrypt, letsencrypt-sites], when: ssl.enabled and ssl.provider == 'letsencrypt' }
    - { role: wp-sites, tags: [wp, wp-sites, letsencrypt] }
  handlers:
    - name: reload nginx
      import_tasks: roles/wp-sites/tasks/reload_nginx.yml
      listen: "reload nginx"
